initial_bounds = st_bbox(
c(xmin=-180, ymin=-90, xmax=180, ymax=90),
crs = st_crs(4326))) %>%
add_mvt_layer(
id   = "h3_hex",
name = "Hexagons",
data = mvt_url,
get_fill_color = scale_color_linear(
col = "2022_2",
palette = viridis(6, alpha=0.5),
limits = c(0, 1)),
auto_highlight = TRUE,
pickable = TRUE,
tooltip = c("2022_2"))
mvt_url <- "https://noaa-onms.github.io/cinms-sbcmbon/data/kelp-canopy_tiles/{z}/{x}/{y}.pbf"
rdeck(
map_style = mapbox_dark(),
initial_bounds = st_bbox(
c(xmin=-180, ymin=-90, xmax=180, ymax=90),
crs = st_crs(4326))) %>%
add_mvt_layer(
id   = "h3_hex",
name = "Hexagons",
data = mvt_url,
get_fill_color = scale_color_linear(
col = "2022_2",
palette = viridis(6, alpha=0.5),
limits = c(0, 1)),
auto_highlight = TRUE,
pickable = TRUE,
tooltip = c("2022_2"))
options(rdeck.mapbox_access_token = mb_token)
# servr::httd()
# mvt_url <- "http://127.0.0.1:4321/data/kelp-canopy_tiles/{z}/{x}/{y}.pbf"
# mvt_url <- "https://noaa-onms.github.io/cinms-sbcmbon/data/kelp-canopy_tiles/{z}/{x}/{y}.pbf"
mvt_url <- "https://ahocevar.com/geoserver/gwc/service/tms/1.0.0/ne:ne_10m_admin_0_countries@EPSG%3A900913@pbf/{z}/{x}/{-y}.pbf"
# https://ahocevar.com/geoserver/gwc/service/tms/1.0.0/ne:ne_10m_admin_0_countries@EPSG%3A900913@pbf/1/0/0.pbf
rdeck(
map_style = mapbox_dark(),
initial_bounds = st_bbox(
c(xmin=-180, ymin=-90, xmax=180, ymax=90),
crs = st_crs(4326))) %>%
add_mvt_layer(
id   = "h3_hex",
name = "Hexagons",
data = mvt_url,
get_fill_color = scale_color_linear(
col = "2022_2",
palette = viridis(6, alpha=0.5),
limits = c(0, 1)),
auto_highlight = TRUE,
pickable = TRUE,
tooltip = c("2022_2"))
mvt_url
rdeck(
map_style = mapbox_dark(),
initial_bounds = st_bbox(
c(xmin=-180, ymin=-90, xmax=180, ymax=90),
crs = st_crs(4326))) %>%
add_mvt_layer(
# id   = "h3_hex",
# name = "Hexagons",
id   = "iso_a3",
name = "iso_a3",
data = mvt_url,
# get_fill_color = scale_color_linear(
#   col = "2022_2",
#   palette = viridis(6, alpha=0.5),
#   limits = c(0, 1)),
auto_highlight = TRUE,
pickable = TRUE,
tooltip = c("iso_a3"))
mvt_url <- "https://noaa-onms.github.io/cinms-sbcmbon/data/kelp-canopy_tiles/{z}/{x}/{y}.pbf"
# mvt_url <- "https://ahocevar.com/geoserver/gwc/service/tms/1.0.0/ne:ne_10m_admin_0_countries@EPSG%3A900913@pbf/{z}/{x}/{-y}.pbf"
# https://ahocevar.com/geoserver/gwc/service/tms/1.0.0/ne:ne_10m_admin_0_countries@EPSG%3A900913@pbf/1/0/0.pbf
rdeck(
map_style = mapbox_dark(),
initial_bounds = st_bbox(
c(xmin=-180, ymin=-90, xmax=180, ymax=90),
crs = st_crs(4326))) %>%
add_mvt_layer(
# id   = "h3_hex",
# name = "Hexagons",
id   = "iso_a3",
name = "iso_a3",
id   = "2022_2",
name = "2022_2",
data = mvt_url,
# get_fill_color = scale_color_linear(
#   col = "2022_2",
#   palette = viridis(6, alpha=0.5),
#   limits = c(0, 1)),
auto_highlight = TRUE,
pickable = TRUE,
# tooltip = c("iso_a3"))
tooltip = c("2022_2"))
mvt_url <- "https://noaa-onms.github.io/cinms-sbcmbon/data/kelp-canopy_tiles/{z}/{x}/{y}.pbf"
# mvt_url <- "https://ahocevar.com/geoserver/gwc/service/tms/1.0.0/ne:ne_10m_admin_0_countries@EPSG%3A900913@pbf/{z}/{x}/{-y}.pbf"
# https://ahocevar.com/geoserver/gwc/service/tms/1.0.0/ne:ne_10m_admin_0_countries@EPSG%3A900913@pbf/1/0/0.pbf
rdeck(
map_style = mapbox_dark(),
initial_bounds = st_bbox(
c(xmin=-180, ymin=-90, xmax=180, ymax=90),
crs = st_crs(4326))) %>%
add_mvt_layer(
# id   = "h3_hex",
# name = "Hexagons",
# id   = "iso_a3",
# name = "iso_a3",
id   = "2022_2",
name = "2022_2",
data = mvt_url,
# get_fill_color = scale_color_linear(
#   col = "2022_2",
#   palette = viridis(6, alpha=0.5),
#   limits = c(0, 1)),
auto_highlight = TRUE,
pickable = TRUE,
# tooltip = c("iso_a3"))
tooltip = c("2022_2"))
shelf(beakr, crul, rdeck, viridis)
?servr::httd()
beakr <- newBeakr()
# beakr pipeline
beakr %>%
# Enable CORS
cors() %>%
# Respond to GET requests at the "/hi" route
httpGET(path = "/hi", function(req, res, err) {
print("Hello, World!")
}) %>%
# Respond to GET requests at the "/bye" route
httpGET(path = "/bye", function(req, res, err) {
print("Farewell, my friends.")
}) %>%
# Start the server on port 25118
listen(host = "127.0.0.1", port = 25118, daemon = TRUE)
beakr %>%
# Enable CORS
cors() %>%
# Respond to GET requests at the "/hi" route
httpGET(path = "/hi", function(req, res, err) {
print("Hello, World!")
}) %>%
# Respond to GET requests at the "/bye" route
httpGET(path = "/bye", function(req, res, err) {
print("Farewell, my friends.")
}) %>%
# Host the directory of static files
serveStaticFiles("/data", here("data"), verbose = TRUE) %>%
# Start the server on port 25118
listen(host = "127.0.0.1", port = 25118, daemon = TRUE)
# Stop the beakr instance server
stopServer(beakr)
beakr %>%
# Enable CORS
cors() %>%
# Respond to GET requests at the "/hi" route
httpGET(path = "/hi", function(req, res, err) {
print("Hello, World!")
}) %>%
# Respond to GET requests at the "/bye" route
httpGET(path = "/bye", function(req, res, err) {
print("Farewell, my friends.")
}) %>%
# Host the directory of static files
serveStaticFiles("/data", here("data"), verbose = TRUE) %>%
# Start the server on port 25118
listen(host = "127.0.0.1", port = 25118, daemon = TRUE)
mvt_url <- "http://127.0.0.1:25118/data/kelp-canopy_tiles/{z}/{x}/{y}.pbf"
# mvt_url <- "https://ahocevar.com/geoserver/gwc/service/tms/1.0.0/ne:ne_10m_admin_0_countries@EPSG%3A900913@pbf/{z}/{x}/{-y}.pbf"
# https://ahocevar.com/geoserver/gwc/service/tms/1.0.0/ne:ne_10m_admin_0_countries@EPSG%3A900913@pbf/1/0/0.pbf
rdeck(
map_style = mapbox_dark(),
initial_bounds = st_bbox(
c(xmin=-180, ymin=-90, xmax=180, ymax=90),
crs = st_crs(4326))) %>%
add_mvt_layer(
# id   = "h3_hex",
# name = "Hexagons",
# id   = "iso_a3",
# name = "iso_a3",
id   = "2022_2",
name = "2022_2",
data = mvt_url,
# get_fill_color = scale_color_linear(
#   col = "2022_2",
#   palette = viridis(6, alpha=0.5),
#   limits = c(0, 1)),
auto_highlight = TRUE,
pickable = TRUE,
# tooltip = c("iso_a3"))
tooltip = c("2022_2"))
opts=`--no-tile-compression -f`
source(here::here("lib/common.R"))
remotes::install_github("crazycapivara/h3-r")
# shelf(
#   leaftime,
#   geojsonio, geojsonlint)
shelf(h3, mapview, ncdf4, qfes/rdeck, sf, terra)
# https://crazycapivara.github.io/h3-r/
d_nc <- glue("{dir_data}/knb-lter-sbc.74.17/LandsatKelpBiomass_2022_Q2_withmetadata.nc")
d <- nc_open(d_nc)
# names(d$var) %>% paste(collapse = ", ")
# latitude, longitude, year, quarter, biomass, biomass_se, area, area_se, passes, passes5, passes7, passes8
x  <- ncvar_get(d, "longitude") # 573515
y  <- ncvar_get(d, "latitude")  # 573515
yr <- ncvar_get(d, "year")    # 154
qr <- ncvar_get(d, "quarter") # 154
b  <- ncvar_get(d, "biomass")
# dim(b) # 573515 x 154
p <- tibble(
x = x, y = y, id = 1:length(x)) %>%
st_as_sf(
coords = c("x", "y"), # remove = F,
crs = 4326)
h3_resolutions <- c(3, 5, 7, 9)
p_h3 <- tibble()
ply_h3 <- tibble()
for (res in h3_resolutions){ # res = h3_resolutions[1]
# assign h3_index to each point
h3_idx <- geo_to_h3(p, res)
p_h3 <- bind_rows(
p_h3,
tibble(
id       = 1:length(x),
h3_res   = res,
h3_index = h3_idx) )
# get polygons for unique H3 indexes
ply_h3 <- rbind(
ply_h3,
h3_to_geo_boundary_sf(unique(h3_idx)) %>%
mutate(
h3_res = res) )
}
dimnames(b) <- list(
id = 1:dim(b)[1],
yr_qr = glue("{yr}_{qr}"))
tbl_b <- as_tibble(b) %>%
rowid_to_column("id") %>%
replace(is.na(.), 0)
# summarize biomass for all H3 resolutions and indexes
h_b <- p_h3 %>%
left_join(
tbl_b,  by = "id") %>%
select(-id) %>%
group_by(
h3_res, h3_index) %>%
summarise_all(list(mean))
ply_h3_b <- ply_h3 %>%
left_join(
h_b,
by = c("h3_index", "h3_res"))
for (res in h3_resolutions){ # res = h3_resolutions[1]
geo <- here(glue("data/kelp-canopy_h3-res{res}.geojson"))
ply_h3_b %>%
filter(h3_res == res) %>%
write_sf(geo, delete_dsn = T)
}
mvt_url <- "http://127.0.0.1:25118/data/kelp-canopy_tiles/{z}/{x}/{y}.pbf"
# mvt_url <- "https://ahocevar.com/geoserver/gwc/service/tms/1.0.0/ne:ne_10m_admin_0_countries@EPSG%3A900913@pbf/{z}/{x}/{-y}.pbf"
# https://ahocevar.com/geoserver/gwc/service/tms/1.0.0/ne:ne_10m_admin_0_countries@EPSG%3A900913@pbf/1/0/0.pbf
rdeck(
map_style = mapbox_dark(),
initial_bounds = st_bbox(
c(xmin=-180, ymin=-90, xmax=180, ymax=90),
crs = st_crs(4326))) %>%
add_mvt_layer(
# id   = "h3_hex",
# name = "Hexagons",
# id   = "iso_a3",
# name = "iso_a3",
id   = "2022_2",
name = "2022_2",
data = mvt_url,
# get_fill_color = scale_color_linear(
#   col = "2022_2",
#   palette = viridis(6, alpha=0.5),
#   limits = c(0, 1)),
auto_highlight = TRUE,
pickable = TRUE,
# tooltip = c("iso_a3"))
tooltip = c("2022_2"))
rdeck(
map_style = mapbox_dark(),
initial_bounds = st_bbox(
c(xmin=-180, ymin=-90, xmax=180, ymax=90),
crs = st_crs(4326))) %>%
add_mvt_layer(
# id   = "h3_hex",
# name = "Hexagons",
# id   = "iso_a3",
# name = "iso_a3",
id   = "2022_2",
name = "2022_2",
data = mvt_url,
get_fill_color = scale_color_linear(
col = "2022_2",
palette = viridis(6, alpha=0.5),
limits = c(0, 1)),
auto_highlight = TRUE,
pickable = TRUE,
# tooltip = c("iso_a3"))
tooltip = c("2022_2"))
# Stop the beakr instance server
stopServer(beakr)
mvt_url <- "https://noaa-onms.github.io/cinms-sbcmbon/data/kelp-canopy_tiles/{z}/{x}/{y}.pbf"
# mvt_url <- "http://127.0.0.1:25118/data/kelp-canopy_tiles/{z}/{x}/{y}.pbf"
# mvt_url <- "https://ahocevar.com/geoserver/gwc/service/tms/1.0.0/ne:ne_10m_admin_0_countries@EPSG%3A900913@pbf/{z}/{x}/{-y}.pbf"
# https://ahocevar.com/geoserver/gwc/service/tms/1.0.0/ne:ne_10m_admin_0_countries@EPSG%3A900913@pbf/1/0/0.pbf
rdeck(
map_style = mapbox_dark(),
initial_bounds = st_bbox(
c(xmin=-180, ymin=-90, xmax=180, ymax=90),
crs = st_crs(4326))) %>%
add_mvt_layer(
# id   = "h3_hex",
# name = "Hexagons",
# id   = "iso_a3",
# name = "iso_a3",
id   = "2022_2",
name = "2022_2",
data = mvt_url,
get_fill_color = scale_color_linear(
col = "2022_2",
palette = viridis(6, alpha=0.5),
limits = c(0, 1)),
auto_highlight = TRUE,
pickable = TRUE,
# tooltip = c("iso_a3"))
tooltip = c("2022_2"))
rdeck(
map_style = mapbox_dark(),
initial_bounds = st_bbox(
c(xmin=-180, ymin=-90, xmax=180, ymax=90),
crs = st_crs(4326))) %>%
add_mvt_layer(
# id   = "h3_hex",
# name = "Hexagons",
# id   = "iso_a3",
# name = "iso_a3",
id   = "Kelp Biomass",
name = "2022, 2nd quarter",
data = mvt_url,
get_fill_color = scale_color_linear(
col = "2022_2",
palette = viridis(6, alpha=0.5),
limits = c(0, 1)),
auto_highlight = TRUE,
pickable = TRUE,
# tooltip = c("iso_a3"))
tooltip = c("2022_2"))
ply_h3_b %>%
select(`2022_2`) %>%
range()
ply_h3_b
ply_h3_b %>%
select(`2022_2`)
ply_h3_b %>%
pull(`2022_2`) %>%
range()
ply_h3_b %>%
pull(`2022_2`) %>%
max()
b_max <- max(pull(ply_h3_b, `2022_2`))
rdeck(
map_style = mapbox_dark(),
initial_bounds = st_bbox(
c(xmin=-180, ymin=-90, xmax=180, ymax=90),
crs = st_crs(4326))) %>%
add_mvt_layer(
# id   = "h3_hex",
# name = "Hexagons",
# id   = "iso_a3",
# name = "iso_a3",
id   = "Kelp Biomass",
name = "2022, 2nd quarter",
data = mvt_url,
get_fill_color = scale_color_linear(
col = "2022_2",
palette = viridis(6, alpha=0.5),
limits = c(0, b_max)),
auto_highlight = TRUE,
pickable = TRUE,
# tooltip = c("iso_a3"))
tooltip = c("2022_2"))
ply_h3_b %>%
filter(h3_res == 5) %>%
select(`2022_2`) %>%
mapview()
ply_h3_b %>%
filter(h3_res == 3) %>%
select(`2022_2`) %>%
mapview()
readLines("~/My Drive/private/mapbox_token_bdbest.txt")
rdeck(
map_style = mapbox_dark(),
initial_bounds = st_bbox(
c(xmin=-180, ymin=-90, xmax=180, ymax=90),
crs = st_crs(4326))) %>%
add_mvt_layer(
id   = "Kelp Biomass",
name = "2022, 2nd quarter",
data = mvt_url,
get_fill_color = scale_color_linear(
col = "2022_2",
palette = viridis(6, alpha=0.5),
limits = c(0, b_max)),
auto_highlight = TRUE,
pickable = TRUE,
# tooltip = c("iso_a3"))
tooltip = c("2022_2"))
rdeck(
map_style = mapbox_dark(),
initial_bounds = st_bbox(
c(xmin=-180, ymin=-90, xmax=180, ymax=90),
crs = st_crs(4326))) %>%
add_mvt_layer(
id   = "kelp_biomass",
name = "Kelp Biomass",
data = mvt_url,
get_fill_color = scale_color_linear(
col = "2022_2",
palette = viridis(6, alpha=0.5),
limits = c(0, b_max)),
auto_highlight = TRUE,
pickable = TRUE,
tooltip = c("2022_2"))
d_nc <- glue("{dir_data}/knb-lter-sbc.74.17/LandsatKelpBiomass_2022_Q2_withmetadata.nc")
d <- nc_open(d_nc)
# names(d$var) %>% paste(collapse = ", ")
# latitude, longitude, year, quarter, biomass, biomass_se, area, area_se, passes, passes5, passes7, passes8
x  <- ncvar_get(d, "longitude") # 573515
y  <- ncvar_get(d, "latitude")  # 573515
yr <- ncvar_get(d, "year")    # 154
qr <- ncvar_get(d, "quarter") # 154
b  <- ncvar_get(d, "biomass")
# dim(b) # 573515 x 154
p <- tibble(
x = x, y = y, id = 1:length(x)) %>%
st_as_sf(
coords = c("x", "y"), # remove = F,
crs = 4326)
h3_resolutions <- c(3, 5, 7, 9)
p_h3 <- tibble()
ply_h3 <- tibble()
for (res in h3_resolutions){ # res = h3_resolutions[1]
# assign h3_index to each point
h3_idx <- geo_to_h3(p, res)
p_h3 <- bind_rows(
p_h3,
tibble(
id       = 1:length(x),
h3_res   = res,
h3_index = h3_idx) )
# get polygons for unique H3 indexes
ply_h3 <- rbind(
ply_h3,
h3_to_geo_boundary_sf(unique(h3_idx)) %>%
mutate(
h3_res = res) )
}
# p_h3 %>%
#   filter(h3_res == 3) %>%
#   {table(.$h3_index)}
# biomass to tibble
dimnames(b) <- list(
id = 1:dim(b)[1],
yr_qr = glue("{yr}_{qr}"))
tbl_b <- as_tibble(b) %>%
rowid_to_column("id") %>%
replace(is.na(.), 0)
# summarize biomass for all H3 resolutions and indexes
h_b <- p_h3 %>%
left_join(
tbl_b,  by = "id") %>%
select(-id) %>%
group_by(
h3_res, h3_index) %>%
summarise_all(list(mean))
# join biomass to polygons by h3_index
ply_h3_b <- ply_h3 %>%
left_join(
h_b,
by = c("h3_index", "h3_res"))
write_sf(ply_h3_b, here("data/kelp_canopy_h3.geojson"))
ply_h3_b_geo <- here("data/kelp_canopy_h3.geojson")
write_sf(ply_h3_b, ply_h3_b_geo)
write_sf(ply_h3_b, ply_h3_b_geo, delete_dsn = T)
ply_h3_b_geo <- read_sf(ply_h3_b_geo)
ply_h3_b_geo <- here("data/kelp_canopy_h3.geojson")
ply_h3_b <- read_sf(ply_h3_b_geo)
ply_h3_b %>%
filter(h3_res == 3) %>%
select(`2022_2`) %>%
mapview()
bb <- st_bbox(ply_h3_b)
bb <- st_bbox(ply_h3_b)
rdeck(
map_style = mapbox_dark(),
initial_bounds = bb) %>%
add_mvt_layer(
id   = "kelp_biomass",
name = "Kelp Biomass",
data = mvt_url,
get_fill_color = scale_color_linear(
col = "2022_2",
palette = viridis(6, alpha=0.5),
limits = c(0, b_max)),
auto_highlight = TRUE,
pickable = TRUE,
tooltip = c("2022_2"))
